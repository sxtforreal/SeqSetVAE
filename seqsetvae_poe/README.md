SeqSetVAE + PoE Dynamics (EHR trajectories)

本仓库实现了一套用于时序 EHR 的两阶段表示与动力学建模方案：
- SetVAE：把每个时间戳处的“事件集合”（set）编码为对角高斯分布，用于刻画“该时刻的病人状态”。
- 动能模型（Dynamics）：汇总先前所有时刻的信息，学习“病人状态随时间如何演化”，为下一时刻提供一个先验分布，并与当前观测融合得到“过滤后的后验”。

一、SetVAE（每个 set → 一个高斯分布）

目标
- 将每个 set 的“无序事件集合”编码为一个低维、解释友好且可不确定性量化的状态分布 q_x(z_t|x_t)=N(μ_e, diag(σ_e^2))。
- 模型对 set 内元素置换不敏感（Permutation-Invariant），并能在没有 set-level 标签的情况下通过重构学习出“有用的”状态表示。

设计
- 输入构造：
  - 事件名通过离线词嵌入（如 768 维）映射到向量，数值经统计量归一化。
  - 对每个 token，方向 = 归一化嵌入向量，幅度 = 归一化的数值，二者相乘得到目标向量。
- 编码器（modules.SetVAEModule）:
  - ISAB/多头注意力对 set 做聚合，逐层产出 (μ, logσ^2) 形成分层潜变量；预训练阶段使用最后一层。
  - 置换不敏感：用注意力与池化对集合做顺序无关的聚合。
- 解码器：
  - 通过注意力瓶颈逐步生成与目标 set 中元素数相同的向量，损失用 Chamfer 距离（方向/幅度/全向量综合）。
- 训练目标（SetVAE 预训练）：
  - 重构损失：Chamfer-based permutation-invariant loss。
  - KL 正则：KL(q(z|x) || N(0,I))，带 free-bits 与 KL 容量日程，防止后验坍塌。

输出含义
- 对角高斯：均值 μ_e 是该 set 的状态估计，方差 σ_e^2 表示不确定性。
- 该分布是“瞬时观测信念”，不利用历史，后续需要与轨迹先验融合。

二、动能模型（Dynamics）：轨迹先验 + 过滤更新

目标
- 学习 p_θ(z_t|z_{<t}, Δt) 给出“下一时刻最可能状态”的先验高斯分布，用以刻画轨迹的动向（速度/加速度/周期等）。
- 与 SetVAE 的观测信念进行贝叶斯式融合，获得“更接近真实的当前状态”并反馈给动力学，形成稳定的在线滤波循环。

设计选择（本实现，推荐）
- 动力学骨干：GRU（或 GRU-D）
  - 优点：在线、O(T) 推理、易与高斯头对接、不规则时间可通过 Δt 嵌入处理。
  - 每步用 h_{t-1} 通过 prior_head 输出先验 N(μ_p, diag(σ_p^2))。
- 条件似然专家 + PoE 融合（Conditional PoE）
  - 直觉：SetVAE 编码器输出的是“在标准先验下的后验”（容易与时间先验重复计数）。为更严谨，我们让“似然专家”从 set 的聚合表示与先验共同条件化，直接输出自然参数增量（精度与精度×均值），然后与先验在自然参数空间做积：
    Λ_post = Λ_p + β_t·Λ_like，h_post = Λ_p·μ_p + β_t·h_like
    μ_post = Λ_post^{-1}·h_post，Σ_post = Λ_post^{-1}
  - 好处：避免对同一信息重复计数；与动力学头自然结合；可控地注入观测权重。
- 自适应门控 β_t
  - 依据分歧与不确定性差异动态调整观测权重：
    - 马氏分歧：d_t^2=(μ_e-μ_p)^T(Σ_p+Σ_e)^{-1}(μ_e-μ_p)
    - 熵差：ΔH = 0.5·log|Σ_p| − 0.5·log|Σ_e|
    - 时间间隔：log(1+Δt)
  - 小网络将上述特征映射到 β_t∈[β_min, β_max]。分歧大或观测更自信时，加大 β_t。

训练与推理
- 推理循环（在线过滤）
  1) 先验：p_t=N(μ_p,Σ_p)
  2) 观测：q_e=N(μ_e,Σ_e) 与/或 set 聚合表示
  3) PoE 融合：q_post=N(μ_post,Σ_post)
  4) 用 μ_post 更新 GRU 隐状态
- 训练目标（无标签）
  - 分步最小化 KL(q_post || p_θ(·|h_{t-1}))。
  - 可加下一步“变化预测”辅助任务：根据 h_t 预测下一 set 是否有非 carry 新事件。
  - 两阶段：先冻结 SetVAE，稳定后再小步解冻 encoder（decoder 视需要）。

变化/突发事件检测（无标签）
- 指标：KL(q_post || p_t)、d_t^2、熵降幅 log|Σ_p| − log|Σ_post|。
- 阈值：在验证集按分位数（如 p95/p99）设阈触发告警；可按科室/人群分层。

实践建议
- 默认配置：GRU 动力学 + 条件似然专家 + 自适应 PoE（已设为默认）。
- 数据较少：减小 latent_dim、增大 KL 预热、降低 poe_beta_max。
- 不规则时间强：把 Δt 输入 GRU（时间桶嵌入）或用 GRU-D；进一步可考虑 ODE-RNN。
- 生成一致性：端到端微调 encoder（必要时再解冻 decoder），监控重构与 KL 活跃度。

目录结构与关键脚本
- modules.py：SetVAE 编码/解码模块、注意力积木、损失。
- model.py：SetVAEOnlyPretrain（SetVAE 预训练）；PoESeqSetVAEPretrain（GRU 先验 + 条件似然专家 + 自适应 PoE）。
- LVCF.py：把原始 EHR 逐病人展开为 LVCF 表。
- dataset.py：按病人拼批，保持 set 边界。
- _setvae_PT.py：SetVAE 预训练入口。
- _poe_PT.py：PoE 动力学训练入口（默认“最佳策略”）。
- _eval_PT.py：预训练评估与可视化。

术语备忘
- 先验（prior）：动力学根据历史对当前状态的预测分布。
- 观测（observation/encoder posterior）：仅由当前 set 估计的状态分布或其聚合表示。
- 后验（posterior/filtering）：融合先验与观测后的当前状态估计。
- 创新量/分歧：先验与观测/后验的差异（如 KL 或马氏距离），可用于异常/突变检测。

如需 API 级推理辅助函数（导出每步先验/后验/创新分数），或 ODE-RNN/Transformer-XL 增强版本，请提出需求。
