# 脚本运行说明

本文档详细说明如何运行 SeqSetVAE 项目中的各个脚本。

## 环境准备

### 1. 安装依赖
```bash
pip install torch torchvision torchaudio
pip install lightning
pip install torchmetrics
pip install matplotlib seaborn
pip install pandas numpy scipy
```

### 2. 检查硬件配置
脚本会自动检测您的硬件配置，但建议确保：
- **GPU训练**: 推荐8GB以上显存，支持CUDA
- **CPU训练**: 推荐8核以上CPU，16GB以上内存

## 核心脚本运行方法

### 1. 训练脚本 (`train_optimized.py`)

**基本运行命令**:
```bash
python train_optimized.py --batch_size 4 --max_epochs 100
```

**完整参数示例**:
```bash
python train_optimized.py \
    --batch_size 4 \
    --max_epochs 100 \
    --num_workers 4 \
    --gradient_accumulation_steps 2 \
    --precision 16-mixed \
    --compile_model \
    --fast_detection
```

**主要参数说明**:
- `--batch_size`: 批次大小（根据GPU内存调整）
- `--max_epochs`: 最大训练轮数
- `--num_workers`: 数据加载器工作进程数
- `--gradient_accumulation_steps`: 梯度累积步数
- `--precision`: 训练精度（16, 32, 16-mixed）
- `--compile_model`: 启用模型编译优化
- `--fast_detection`: 快速检测模式

**从检查点恢复训练**:
```bash
python train_optimized.py \
    --batch_size 4 \
    --max_epochs 100 \
    --resume_from_checkpoint path/to/checkpoint.ckpt
```

### 2. 检查点清理脚本 (`cleanup_checkpoints.py`)

**检查检查点状态**:
```bash
python cleanup_checkpoints.py --checkpoint_dir ./checkpoints
```

**预览清理操作**:
```bash
python cleanup_checkpoints.py \
    --checkpoint_dir ./checkpoints \
    --cleanup \
    --dry_run
```

**执行清理操作**:
```bash
python cleanup_checkpoints.py \
    --checkpoint_dir ./checkpoints \
    --cleanup
```

**参数说明**:
- `--checkpoint_dir`: 检查点目录路径
- `--cleanup`: 执行清理操作
- `--dry_run`: 预览模式，不实际删除文件

### 3. 模型分析脚本 (`comprehensive_analyzer.py`)

**运行分析**:
```bash
python comprehensive_analyzer.py \
    --checkpoint_path path/to/model.ckpt \
    --data_path path/to/test_data \
    --output_dir ./analysis_results
```

**参数说明**:
- `--checkpoint_path`: 模型检查点路径
- `--data_path`: 测试数据路径
- `--output_dir`: 分析结果输出目录

### 4. 可视化脚本 (`comprehensive_visualizer.py`)

**生成可视化图表**:
```bash
python comprehensive_visualizer.py \
    --checkpoint_path path/to/model.ckpt \
    --data_path path/to/data \
    --output_dir ./visualizations
```

**参数说明**:
- `--checkpoint_path`: 模型检查点路径
- `--data_path`: 数据路径
- `--output_dir`: 可视化结果输出目录

## 配置管理

### 1. 环境变量设置

**GPU设置**:
```bash
export CUDA_VISIBLE_DEVICES=0,1  # 使用GPU 0和1
export PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:512
```

**CPU设置**:
```bash
export OMP_NUM_THREADS=8  # 设置CPU线程数
```

### 2. 配置文件修改

编辑 `config.py` 文件来调整模型参数：
```python
# 模型参数
input_dim = 128
reduced_dim = 64
latent_dim = 32
levels = 3
heads = 8
m = 4

# 训练参数
lr = 1e-4
beta = 0.1
batch_size = 4
```

## 运行流程示例

### 1. 首次训练
```bash
# 1. 检查硬件配置
python -c "import config; print(config.device_config)"

# 2. 开始训练
python train_optimized.py --batch_size 4 --max_epochs 100

# 3. 监控训练进度
tensorboard --logdir ./lightning_logs
```

### 2. 恢复训练
```bash
# 1. 清理无效检查点
python cleanup_checkpoints.py --checkpoint_dir ./checkpoints --cleanup

# 2. 从检查点恢复训练
python train_optimized.py \
    --batch_size 4 \
    --max_epochs 100 \
    --resume_from_checkpoint ./checkpoints/last.ckpt
```

### 3. 模型分析
```bash
# 1. 运行综合分析
python comprehensive_analyzer.py \
    --checkpoint_path ./checkpoints/best_model.ckpt \
    --data_path ./test_data \
    --output_dir ./analysis

# 2. 生成可视化
python comprehensive_visualizer.py \
    --checkpoint_path ./checkpoints/best_model.ckpt \
    --data_path ./test_data \
    --output_dir ./visualizations
```

## 性能优化建议

### GPU训练优化
1. **批次大小调整**:
   - 8GB显存: `--batch_size 2-4`
   - 16GB显存: `--batch_size 4-8`
   - 24GB显存: `--batch_size 8-16`

2. **精度设置**:
   - 大显存GPU: `--precision 16-mixed`
   - 小显存GPU: `--precision 32`

3. **梯度累积**:
   ```bash
   --gradient_accumulation_steps 4  # 有效批次大小 = batch_size * 4
   ```

### CPU训练优化
1. **工作进程数**:
   ```bash
   --num_workers 4  # 根据CPU核心数调整
   ```

2. **禁用GPU优化**:
   ```bash
   --precision 32  # 强制使用32位精度
   ```

## 常见问题解决

### 1. 内存不足错误
```bash
# 减少批次大小
python train_optimized.py --batch_size 2

# 启用梯度累积
python train_optimized.py --batch_size 2 --gradient_accumulation_steps 4
```

### 2. 检查点加载错误
```bash
# 清理无效检查点
python cleanup_checkpoints.py --checkpoint_dir ./checkpoints --cleanup
```

### 3. 训练速度慢
```bash
# 启用模型编译
python train_optimized.py --compile_model

# 调整工作进程数
python train_optimized.py --num_workers 8
```

### 4. 精度问题
```bash
# 使用32位精度
python train_optimized.py --precision 32

# 禁用混合精度
python train_optimized.py --precision 32
```

## 监控和调试

### 1. 训练监控
```bash
# 启动TensorBoard
tensorboard --logdir ./lightning_logs

# 监控GPU使用情况
nvidia-smi -l 1
```

### 2. 日志查看
```bash
# 查看训练日志
tail -f ./lightning_logs/version_X/train.log

# 查看错误日志
grep "ERROR" ./lightning_logs/version_X/train.log
```

### 3. 性能分析
```bash
# 启用性能分析
python train_optimized.py --enable_profiler

# 查看性能报告
python -c "import torch; print(torch.profiler.profile())"
```

## 最佳实践

1. **定期清理检查点**: 使用清理脚本定期删除无效检查点
2. **监控资源使用**: 定期检查GPU内存和CPU使用情况
3. **保存最佳模型**: 确保保存验证集上表现最好的模型
4. **使用早停**: 启用早停机制防止过拟合
5. **备份重要文件**: 定期备份配置文件和重要检查点

## 故障排除

### 检查环境
```bash
# 检查PyTorch安装
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"

# 检查Lightning安装
python -c "import lightning; print(lightning.__version__)"

# 检查GPU驱动
nvidia-smi
```

### 重置环境
```bash
# 清理缓存
rm -rf ./lightning_logs
rm -rf ./checkpoints
rm -rf ./__pycache__

# 重新开始训练
python train_optimized.py --batch_size 4 --max_epochs 100
```