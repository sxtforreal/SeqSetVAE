# Hierarchical SetVAE åéªŒåç¼©è§£å†³æ–¹æ¡ˆ

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆæ¥è§£å†³ Hierarchical SetVAE ä¸­çš„åéªŒåç¼©ï¼ˆPosterior Collapseï¼‰é—®é¢˜ã€‚

## ğŸš¨ åéªŒåç¼©é—®é¢˜

åéªŒåç¼©æ˜¯VAEè®­ç»ƒä¸­çš„ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼Œè¡¨ç°ä¸ºï¼š
- KLæ•£åº¦è¶‹è¿‘äº0
- æ½œåœ¨å˜é‡å¤±å»è¡¨è¾¾èƒ½åŠ›
- æ¨¡å‹é€€åŒ–ä¸ºæ ‡å‡†è‡ªç¼–ç å™¨
- ç”Ÿæˆå¤šæ ·æ€§é™ä½

## âœ… è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

æˆ‘ä»¬å®ç°äº†å¤šå±‚æ¬¡çš„é˜²æŠ¤æªæ–½ï¼š

### 1. Î²é€€ç«ç­–ç•¥ (Beta Annealing)
- **å‘¨æœŸæ€§é€€ç«**: Î²å€¼åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å‘¨æœŸæ€§å˜åŒ–
- **çº¿æ€§é€€ç«**: Î²å€¼ä»å°åˆ°å¤§çº¿æ€§å¢é•¿
- **Sigmoidé€€ç«**: ä½¿ç”¨Sigmoidå‡½æ•°å¹³æ»‘è¿‡æ¸¡

```python
# é…ç½®ç¤ºä¾‹
beta_strategy = "cyclical"  # "linear", "cyclical", "sigmoid"
min_beta = 0.0
max_beta = 0.5
cycle_length = 5000
beta_warmup_steps = 1000
```

### 2. è°±å½’ä¸€åŒ– (Spectral Normalization)
- ç¨³å®šè®­ç»ƒè¿‡ç¨‹
- é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- æ”¹å–„ç”Ÿæˆè´¨é‡

```python
use_spectral_norm = True
```

### 3. æ”¹è¿›çš„Free Bitsç­–ç•¥
- æ¯ä¸ªç»´åº¦ç‹¬ç«‹åº”ç”¨free bits
- å±‚æ¬¡åŒ–KLæƒé‡
- åŠ¨æ€é˜ˆå€¼è°ƒæ•´

```python
free_bits = 0.2
pc_threshold = 0.1
```

### 4. Î²-TC-VAEåˆ†è§£ï¼ˆå¯é€‰ï¼‰
- åˆ†è§£KLæ•£åº¦ä¸ºä¸‰ä¸ªéƒ¨åˆ†
- Index-code MI
- Total Correlation
- Dimension-wise KL

```python
use_tc_decomposition = False  # è®¾ä¸ºTrueå¯ç”¨
```

### 5. å®æ—¶ç›‘æ§å’Œè¯Šæ–­
- KLæ•£åº¦ç›‘æ§
- æ´»è·ƒå•å…ƒç»Ÿè®¡
- æ½œåœ¨ç©ºé—´åˆ†æ
- åéªŒåç¼©æ£€æµ‹

## ğŸ“ æ–‡ä»¶ç»“æ„

```
â”œâ”€â”€ model.py                              # æ”¹è¿›çš„æ¨¡å‹å®ç°
â”œâ”€â”€ modules.py                             # æ ¸å¿ƒæ¨¡å—å’ŒæŸå¤±å‡½æ•°
â”œâ”€â”€ config.py                              # é…ç½®æ–‡ä»¶
â”œâ”€â”€ train.py                               # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ posterior_collapse_diagnostics.py      # è¯Šæ–­å·¥å…·
â”œâ”€â”€ example_usage.py                       # ä½¿ç”¨ç¤ºä¾‹
â””â”€â”€ README_posterior_collapse_solution.md  # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬è®­ç»ƒ

```bash
python train.py
```

### 2. ä½¿ç”¨ç¤ºä¾‹è„šæœ¬

```bash
python example_usage.py
```

### 3. åˆ†æç°æœ‰æ¨¡å‹

```bash
python example_usage.py analyze
```

### 4. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š

```python
from posterior_collapse_diagnostics import PosteriorCollapseDiagnostics

diagnostics = PosteriorCollapseDiagnostics()
report = diagnostics.generate_training_report(model, dataloader)
```

## âš™ï¸ å…³é”®å‚æ•°é…ç½®

### åŸºç¡€å‚æ•°
```python
# æ¨¡å‹æ¶æ„
latent_dim = 256
levels = 2
heads = 2
m = 16

# è®­ç»ƒå‚æ•°
lr = 1e-4
beta = 0.5
free_bits = 0.2
```

### åéªŒåç¼©é˜²æŠ¤å‚æ•°
```python
# è°±å½’ä¸€åŒ–
use_spectral_norm = True

# Î²é€€ç«
beta_strategy = "cyclical"
min_beta = 0.0
cycle_length = 5000
beta_warmup_steps = 1000

# TCåˆ†è§£
use_tc_decomposition = False

# ç›‘æ§é˜ˆå€¼
pc_threshold = 0.1
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š

### åŸºç¡€æŒ‡æ ‡
- `train_loss` / `val_loss`: æ€»æŸå¤±
- `train_recon` / `val_recon`: é‡æ„æŸå¤±  
- `train_kl` / `val_kl`: KLæ•£åº¦
- `current_beta`: å½“å‰Î²å€¼

### åéªŒåç¼©ç›‘æ§æŒ‡æ ‡
- `avg_kl`: å¹³å‡KLæ•£åº¦
- `avg_active_units`: å¹³å‡æ´»è·ƒå•å…ƒæ•°
- `collapse_ratio`: åç¼©æ¯”ä¾‹
- `avg_mutual_info`: å¹³å‡äº’ä¿¡æ¯ä¼°è®¡

### æ½œåœ¨ç©ºé—´æŒ‡æ ‡
- `val_z_var`: æ½œåœ¨å˜é‡æ–¹å·®
- `effective_latent_dims`: æœ‰æ•ˆæ½œåœ¨ç»´åº¦æ•°
- `latent_utilization_ratio`: æ½œåœ¨ç©ºé—´åˆ©ç”¨ç‡

## ğŸ” è¯Šæ–­å·¥å…·ä½¿ç”¨

### 1. å®æ—¶ç›‘æ§
è®­ç»ƒè¿‡ç¨‹ä¸­TensorBoardä¼šæ˜¾ç¤ºæ‰€æœ‰ç›‘æ§æŒ‡æ ‡ï¼š

```bash
tensorboard --logdir outputs/logs
```

### 2. è¯¦ç»†è¯Šæ–­æŠ¥å‘Š
```python
diagnostics = PosteriorCollapseDiagnostics(save_dir="./diagnostics")
report = diagnostics.generate_training_report(model, dataloader)
```

ç”Ÿæˆçš„æŠ¥å‘ŠåŒ…æ‹¬ï¼š
- KLæ•£åº¦åˆ†å¸ƒå›¾
- æ½œåœ¨ç©ºé—´åˆ†æå›¾
- ç›¸å…³æ€§çŸ©é˜µçƒ­å›¾
- æœ‰æ•ˆç»´åº¦ç»Ÿè®¡
- JSONæ ¼å¼çš„è¯¦ç»†æ•°æ®

### 3. è¯Šæ–­ç»“æœè§£è¯»

#### è‰¯å¥½çŠ¶æ€æŒ‡æ ‡ï¼š
- âœ… `collapse_ratio < 0.5`
- âœ… `latent_utilization_ratio > 0.6`  
- âœ… `avg_active_units > latent_dim * 0.3`

#### åéªŒåç¼©è­¦å‘Šï¼š
- âš ï¸ `collapse_ratio > 0.8`
- âš ï¸ `latent_utilization_ratio < 0.3`
- âš ï¸ `avg_kl < 0.1`

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: KLæ•£åº¦è¿‡å°
**ç—‡çŠ¶**: KLæ•£åº¦æŒç»­æ¥è¿‘0
**è§£å†³æ–¹æ¡ˆ**:
- é™ä½åˆå§‹Î²å€¼
- å¢åŠ Î²é€€ç«çš„warmupæ­¥æ•°
- å¢åŠ free_bitså€¼
- æ£€æŸ¥é‡æ„æŸå¤±æ˜¯å¦è¿‡å¤§

### é—®é¢˜2: è®­ç»ƒä¸ç¨³å®š
**ç—‡çŠ¶**: æŸå¤±éœ‡è¡ï¼Œæ¢¯åº¦çˆ†ç‚¸
**è§£å†³æ–¹æ¡ˆ**:
- å¯ç”¨è°±å½’ä¸€åŒ–
- é™ä½å­¦ä¹ ç‡
- ä½¿ç”¨æ¢¯åº¦è£å‰ª
- è°ƒæ•´Î²é€€ç«ç­–ç•¥

### é—®é¢˜3: æ½œåœ¨ç©ºé—´åˆ©ç”¨ç‡ä½
**ç—‡çŠ¶**: å¤§éƒ¨åˆ†ç»´åº¦åç¼©
**è§£å†³æ–¹æ¡ˆ**:
- å‡å°‘æ½œåœ¨ç»´åº¦æ•°
- å¢åŠ æ¨¡å‹å¤æ‚åº¦
- ä½¿ç”¨TCåˆ†è§£
- è°ƒæ•´ç½‘ç»œæ¶æ„

### é—®é¢˜4: ç”Ÿæˆè´¨é‡å·®
**ç—‡çŠ¶**: é‡æ„æ•ˆæœå·®ï¼Œç”Ÿæˆå¤šæ ·æ€§ä½
**è§£å†³æ–¹æ¡ˆ**:
- å¹³è¡¡é‡æ„æŸå¤±å’ŒKLæ•£åº¦
- è°ƒæ•´Î²é€€ç«ç­–ç•¥
- å¢åŠ è®­ç»ƒæ—¶é—´
- æ£€æŸ¥æ•°æ®è´¨é‡

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è¶…å‚æ•°è°ƒä¼˜é¡ºåº
1. é¦–å…ˆè°ƒæ•´Î²é€€ç«ç­–ç•¥
2. ç„¶åä¼˜åŒ–free_bits
3. æœ€åå¾®è°ƒç½‘ç»œæ¶æ„

### 2. è®­ç»ƒç­–ç•¥
- ä½¿ç”¨è¾ƒå°çš„åˆå§‹Î²å€¼
- é€æ­¥å¢åŠ æ¨¡å‹å¤æ‚åº¦
- å®šæœŸæ£€æŸ¥è¯Šæ–­æŠ¥å‘Š
- ä¿å­˜å¤šä¸ªæ£€æŸ¥ç‚¹ä¾¿äºå¯¹æ¯”

### 3. ç¡¬ä»¶ä¼˜åŒ–
- ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
- å¯ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹
- åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°

## ğŸ“š ç†è®ºèƒŒæ™¯

### Î²-VAE
é€šè¿‡è°ƒæ•´KLæ•£åº¦çš„æƒé‡Î²æ¥æ§åˆ¶é‡æ„è´¨é‡å’Œæ­£åˆ™åŒ–å¼ºåº¦çš„å¹³è¡¡ã€‚

### Free Bits
ä¸ºæ¯ä¸ªæ½œåœ¨ç»´åº¦è®¾ç½®æœ€å°KLæ•£åº¦é˜ˆå€¼ï¼Œé˜²æ­¢è¿‡åº¦æ­£åˆ™åŒ–ã€‚

### è°±å½’ä¸€åŒ–
é€šè¿‡é™åˆ¶æƒé‡çŸ©é˜µçš„è°±èŒƒæ•°æ¥ç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚

### Total Correlation
åˆ†è§£KLæ•£åº¦æ¥æ›´å¥½åœ°ç†è§£å’Œæ§åˆ¶æ½œåœ¨å˜é‡çš„ç‹¬ç«‹æ€§ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤é—®é¢˜å’Œæ”¹è¿›å»ºè®®ï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹åéªŒåç¼©é—®é¢˜çš„ç»¼åˆè§£å†³æ–¹æ¡ˆã€‚æ ¹æ®å…·ä½“çš„æ•°æ®å’Œä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å‚æ•°ã€‚å»ºè®®ä»é»˜è®¤é…ç½®å¼€å§‹ï¼Œç„¶åæ ¹æ®è¯Šæ–­ç»“æœè¿›è¡Œè°ƒä¼˜ã€‚